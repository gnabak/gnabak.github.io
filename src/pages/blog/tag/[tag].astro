---
import { getCollection } from 'astro:content';
import PageLayout from '@/layouts/PageLayout.astro';
import BlogCard from '@/components/blog/BlogCard.astro';
import { sortPostsByDate, filterDraftPosts } from '@/utils/sortPosts';
import { getUniqueTags, getPostsByTag } from '@/utils/getAllTags';

export async function getStaticPaths() {
	const allPosts = await getCollection('blog');
	const publishedPosts = filterDraftPosts(allPosts);
	const uniqueTags = getUniqueTags(publishedPosts);

	return uniqueTags.map((tag) => ({
		params: { tag: tag.toLowerCase() },
		props: { tag },
	}));
}

interface Props {
	tag: string;
}

const { tag } = Astro.props;

const allPosts = await getCollection('blog');
const publishedPosts = filterDraftPosts(allPosts);
const taggedPosts = getPostsByTag(publishedPosts, tag);
const posts = sortPostsByDate(taggedPosts);
---

<PageLayout
	title={`Posts tagged "${tag}"`}
	description={`Blog posts tagged with ${tag}.`}
>
	<div class="mb-8">
		<a href="/blog" class="font-mono text-sm text-comment hover:text-green transition-colors">
			‚Üê Back to Blog
		</a>
	</div>

	<div class="mb-12 space-y-2">
		<h1 class="font-display text-3xl font-bold text-gold">
			Tagged "{tag}"
		</h1>
		<p class="font-mono text-comment">
			{posts.length} {posts.length === 1 ? 'post' : 'posts'}
		</p>
	</div>

	{posts.length > 0 ? (
		<div class="space-y-6">
			{posts.map((post) => (
				<BlogCard post={post} />
			))}
		</div>
	) : (
		<p class="text-comment">No posts with this tag.</p>
	)}
</PageLayout>
