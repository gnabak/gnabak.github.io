---
import { getCollection } from 'astro:content';
import PageLayout from '@/layouts/PageLayout.astro';
import BlogCard from '@/components/blog/BlogCard.astro';
import { sortPostsByDate, filterDraftPosts } from '@/utils/sortPosts';
import { getUniqueTags, getPostsByTag } from '@/utils/getAllTags';

export async function getStaticPaths() {
	const allPosts = await getCollection('blog');
	const publishedPosts = filterDraftPosts(allPosts);
	const uniqueTags = getUniqueTags(publishedPosts);

	return uniqueTags.map((tag) => ({
		params: { tag: tag.toLowerCase() },
		props: { tag },
	}));
}

interface Props {
	tag: string;
}

const { tag } = Astro.props;

const allPosts = await getCollection('blog');
const publishedPosts = filterDraftPosts(allPosts);
const taggedPosts = getPostsByTag(publishedPosts, tag);
const posts = sortPostsByDate(taggedPosts);
---

<PageLayout
	title={`Posts tagged "${tag}"`}
	description={`Blog posts tagged with ${tag}.`}
>
	<div class="mb-12 space-y-6">
		<div class="font-mono text-sm space-y-1">
			<p>
				<span class="text-comment">$</span> <span class="text-foreground">grep -r "{tag}" ~/posts</span>
			</p>
			<p class="text-comment">&gt; {posts.length} {posts.length === 1 ? 'post' : 'posts'} found</p>
		</div>
	</div>

	{posts.length > 0 ? (
		<div class="space-y-6">
			{posts.map((post, index) => (
				<BlogCard post={post} lineNumber={index + 1} />
			))}
		</div>
	) : (
		<p class="text-comment">No posts with this tag.</p>
	)}
</PageLayout>
